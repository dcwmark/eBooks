/*1330961628,176833974*/

if (window.CavalryLogger) { CavalryLogger.start_js(["+1A5z"]); }

__e("RequiredFormListener",["event-extensions","Input"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Input');Event.listen(document.documentElement,'submit',function(h){var i=h.getTarget().getElementsByTagName('*');for(var j=0;j<i.length;j++)if(i[j].getAttribute('required')&&g.isEmpty(i[j])){i[j].focus();return false;}},Event.Priority.URGENT);});
function AdminRecordsRenderer(a,b,c,d,e,f,g,h,i,j){this.root=$(a);this.item_list=b;this.add_item_data=c;this.type_names=d;this.tokenizer=$(e).tokenizer;this.tokenizer.ontokenadded=this.tokenizer.ontokenremoved=bind(this,this.filter,0);this.next_txns_button=$(h);this.next_txns_button.onclick=bind(this,this.next_txns);this.prev_txns_button=$(g);this.prev_txns_button.onclick=bind(this,this.prev_txns);this.add_item_buttons=[];this.initElements();this.subject_id=f;this.start_txn=i;this.number_txn_per_page=j;}copy_properties(AdminRecordsRenderer.prototype,{getRoot:function(){return this.root;},filter:function(a){var b=document.getElementsByName(this.tokenizer.obj.id+'[]'),c=[];for(var d=0;d<b.length;d++){var e=b[d].value.split(':'),f=null,g=null;if(e.length==1){f=e[0];}else if(e.length==2){f=e[0];g=e[1];}c.push(f);}CSS.addClass('admin_records_body_'+this.subject_id,'async_saving');UIPagelet.loadFromEndpoint('AdminRecordsPageletWrapper','admin_records_attach_node_'+this.subject_id,{record_subject:this.subject_id,filters:c,start_txn:a},{intern:true});},next_txns:function(){this.start_txn+=this.number_txn_per_page;this.filter(this.start_txn);},prev_txns:function(){this.start_txn-=this.number_txn_per_page;this.filter(this.start_txn);},getAddItemInputs:function(a){var b=DOM.find(this.root,'div.admin_records_add_item_'+a),c='td.ar_input_cell .ar_input';return DOM.scry(b,c);},initAddItemCollapsibles:function(a){var b=ge(this.root.id),c=this.getAddItemInputs(a);for(var d=0;d<c.length;d++){Event.listen(c[d],'focus',function(event){DataStore.set(b,'add_item_focus',true);if(CSS.hasClass(event.getTarget(),'ar_compact')){var e=DOM.find(b,'div.admin_records_add_item_'+a),f='tr.ar_hide',g=DOM.scry(e,f);for(var h=0;h<g.length;h++){CSS.setStyle(g[h],'height','0');CSS.removeClass(g[h],'ar_hide');CSS.addClass(g[h],'ar_show');}var i=DOM.scry(e,'td.ar_input_cell textarea.ar_compact');for(var h=0;h<i.length;h++){CSS.removeClass(i[h],'ar_compact');CSS.addClass(i[h],'ar_expanded');}}});Event.listen(c[d],'blur',function(event){DataStore.set(b,'add_item_focus',false);window.setTimeout(function(){if(DataStore.get(b,'add_item_focus'))return false;var e=DOM.find(b,'div.admin_records_add_item_'+a),f=DOM.scry(e,'td.ar_input_cell *'),g=DOM.scry(e,'tr.ar_show'),h=DOM.scry(e,'td.ar_input_cell '+'textarea.ar_expanded');for(var i=0;i<f.length;i++)if(Input.getValue(f[i]))return false;for(var i=0;i<g.length;i++){CSS.setStyle(g[i],'height','0');CSS.removeClass(g[i],'ar_show');CSS.addClass(g[i],'ar_hide');}for(var i=0;i<h.length;i++){CSS.addClass(h[i],'ar_compact');CSS.removeClass(h[i],'ar_expanded');}},150);});}},addItem:function(a){var b=this.add_item_buttons[a];b.disabled='disabled';this.current_disabled_button=b;CSS.addClass(b,'disabled');var c=this.add_item_data[a],d=c.record_payload,e={};for(field in d){var f=AdminRecordsRenderer.getPayloadFieldInput(a,field);e[field]=f.value;}var g={record_subject:c.record_subject,record_type:c.record_type,actor_id:c.actor_id,record_payload:e,callback:c.callback,add_item_index:a};if(c.pre_js_callback){var h=new Function('data',c.pre_js_callback);h(g);}this.data=g;new AsyncRequest().setURI('/intern/ajax/xtrans/admin_records_renderer.php').setReadOnly(true).setData(g).setHandler(bind(this,this.addItemHandler)).setFinallyHandler(bind(this,this.reenableButton)).send();},reenableButton:function(){if(this.current_disabled_button)this.current_disabled_button.disabled='';},setNoRefresh:function(){this.no_refresh=true;},addItemHandler:function(a){var b=a.getPayload(),c,d;if(b){var e=b.add_item_index,f=this.add_item_data[e];if(f.post_js_callback){var g=new Function('payload',f.post_js_callback);g(b);if(b.dont_refresh||this.no_refresh)return;}var h=b.record_type,i=b.record_subtype;b=new HTML(b.html);var j=DOM.scry(this.root,'div.admin_records_body div.ar_item');if(j.length>0){d=DOM.insertBefore(b,j[0])[0];}else{var k=DOM.find(this.root,'div.admin_records_body');d=DOM.setContent(k,b)[0];}CSS.hide(d);c=j.length;var l='admin_records_item_'+c;CSS.addClass(d,l);this.item_list[l]={record_type:h,record_subtype:i};this.initCollapsibles(d);var m=DOM.find(this.root,'div.admin_records_body div.'+l);CSS.setStyle(m,'height: 0');this.filter();animation(m).to('height','auto').from('0px').blind().show().ease(animation.ease.end).duration(300).go();var n=this.tokenizer.typeahead_source;if(n&&n.values){var o=false;for(var p=0;p<n.values.length;p++)if(n.values[p].i==h+':'+i){o=true;break;}if(!o){var q=this.type_names[h];n.values.push({t:q+': '+i,i:h+':'+i});n.values.sort(function sort(t,u){return t.t<u.t;});n.build_index();}}var r=f.record_payload;for(field in r){var s=AdminRecordsRenderer.getPayloadFieldInput(e,field);s.value=r[field]['default'];}}},toggleCollapsible:function(a){toggle(a.nextSibling);if(CSS.hasClass(a,'ar_collapsible_open')){CSS.removeClass(a,'ar_collapsible_open');CSS.addClass(a,'ar_collapsible_closed');}else{CSS.removeClass(a,'ar_collapsible_closed');CSS.addClass(a,'ar_collapsible_open');}},initCollapsibles:function(a){var b=DOM.scry(a,'a.ar_collapsible_link'),c=function(f,g){var h=function(){g.toggleCollapsible(f);return false;};return h;};for(var d=0;d<b.length;d++){var e=b[d];Event.listen(e,'click',c(e,this));}},initElements:function(){this.initCollapsibles(this.root);this.add_item_buttons=DOM.scry(this.root,'td.ar_button label input');var a=function(c,d){var e=function(){d.addItem(c);return false;};return e;};for(var b=0;b<this.add_item_buttons.length;b++){this.initAddItemCollapsibles(b);Event.listen(this.add_item_buttons[b],'click',a(b,this));}}});AdminRecordsRenderer.prefillItem=function(a,b){for(field in b){var c=AdminRecordsRenderer.getPayloadFieldInput(a,field);if(c)c.value=b[field];}};AdminRecordsRenderer.getPayloadFieldInput=function(a,b){if(adminRecordsRenderer){root=adminRecordsRenderer.getRoot();}else root=document.body;var c=DOM.find(root,'div.admin_records_add_item_'+a),d='td.ar_input_cell[data-payloadtype="'+b+'"] .ar_input';return DOM.find(c,d);};